# План интеграции концепций claude-task-master в проект "Рикошет"

Этот документ описывает, как концепции и подходы из проекта [claude-task-master](https://github.com/eyaltoledano/claude-task-master) могут быть интегрированы в проект "Рикошет" для улучшения его функциональности и пользовательского опыта.

## 1. Обзор claude-task-master

Claude Task Master — это система управления задачами, разработанная для AI-ассистентов, которая:

1. **Разбивает проектные требования** на структурированные, выполнимые задачи
2. **Отслеживает зависимости** между задачами
3. **Определяет последовательность** выполнения задач
4. **Поддерживает контекст** между сессиями работы с AI-ассистентами
5. **Интегрируется с различными средами разработки** через MCP (Model Control Protocol)

Ключевая ценность claude-task-master — создание общего контекста между человеком и AI-ассистентом, что позволяет эффективно работать над сложными проектами.

## 2. Сопоставление концепций

| Концепция в claude-task-master | Аналог в "Рикошет" | Потенциал интеграции | Статус |
|-------------------------------|-------------------|---------------------|--------|
| Парсинг PRD-документов в задачи | Сегментация входящих данных | Можно адаптировать парсер PRD для сегментации больших документов | ✅ Базовая интеграция |
| Цепочки задач с зависимостями | Линейные цепочки моделей | Расширить концепцию цепочек до графов с зависимостями | ⏳ В процессе (45%) |
| Система статусов задач | Чекпоинты | Добавить метаданные к чекпоинтам для отслеживания статуса | ✅ Завершено |
| Интеграция через MCP | API Gateway | Реализовать поддержку MCP для интеграции с редакторами | ⏳ В процессе (45%) |
| Файл tasks.json | Хранилище метаданных в PostgreSQL | Структура данных задач может быть адаптирована для БД | ⏳ В процессе (35%) |
| Поддержка разных AI-моделей | Подключение разных LLM | Использовать аналогичный подход к менеджменту API-ключей | ✅ Завершено |
| Интерактивный выбор моделей | Настройка моделей для ролей | Адаптировать интерактивный интерфейс выбора моделей | ⏳ В процессе (60%) |

## 3. Ключевые компоненты для интеграции

### 3.1. Формат задачи

В claude-task-master каждая задача имеет следующую структуру:

```json
{
  "id": "task-1",
  "title": "Реализовать функцию сегментации текста",
  "description": "Создать функцию, которая разбивает большой текст на сегменты по ~2000 токенов с умным разделением на абзацы",
  "status": "todo",
  "dependencies": ["task-0"],
  "complexity": "medium",
  "files": ["src/segmentation.go"],
  "notes": "Использовать регулярные выражения для определения границ абзацев"
}
```

Для "Рикошет" реализовано:
1. ✅ Адаптирован формат для хранения в файловой системе
2. ✅ Добавлены поля для метаданных о цепочке моделей
3. ⏳ Расширено поле `dependencies` для поддержки направленного графа задач (45%)
4. ✅ Добавлены поля для отслеживания выполнения моделей в цепочке

### 3.2. MCP-интеграция

Claude Task Master использует MCP (Model Control Protocol) для интеграции с редакторами. Для "Рикошет" реализовано:

1. ✅ Базовая структура MCP-сервера для интеграции с редакторами (Cursor, VS Code)
2. ✅ Базовый набор команд для взаимодействия с "Рикошет" через чат в редакторе
3. ✅ Использование существующей документации claude-task-master по настройке MCP
4. ⏳ Интерактивное конструирование цепочек моделей (30%)
5. ⏳ Визуализация выполнения цепочек в редакторе (45%)

Пример конфигурации MCP для "Рикошет":

```json
{
  "mcpServers": {
    "ricochet": {
      "command": "ricochet-task",
      "args": ["mcp"],
      "env": {
        "ANTHROPIC_API_KEY": "YOUR_ANTHROPIC_API_KEY_HERE",
        "OPENAI_API_KEY": "YOUR_OPENAI_KEY_HERE",
        "GOOGLE_API_KEY": "YOUR_GOOGLE_KEY_HERE"
      }
    }
  }
}
```

#### 3.2.1. Команды MCP для интеграции с редакторами

Следующие MCP-команды реализованы для взаимодействия с Ricochet в редакторе:

1. **Базовые команды**:
   - `ricochet_init`: Инициализация проекта Ricochet ✅
   - `ricochet_config`: Просмотр и изменение конфигурации ✅
   - `ricochet_status`: Проверка статуса компонентов Ricochet ✅

2. **Команды для управления цепочками**:
   - `chain_create`: Создание новой цепочки моделей ✅
   - `chain_list`: Просмотр списка доступных цепочек ✅
   - `chain_run`: Запуск цепочки моделей ✅
   - `chain_edit`: Редактирование существующей цепочки ⏳ (50%)
   - `chain_delete`: Удаление цепочки ✅

3. **Команды для управления моделями**:
   - `models_setup`: Интерактивный выбор моделей ✅
   - `models_list`: Просмотр настроенных моделей ✅
   - `models_set`: Установка конкретной модели для роли ⏳ (60%)
   - `models_reset`: Сброс настроек моделей ⏳ (65%)

4. **Команды для управления задачами**:
   - `tasks_list`: Отображение списка активных задач ⏳ (35%)
   - `task_details`: Просмотр деталей задачи ⏳ (20%)
   - `task_status`: Отслеживание статуса выполнения задачи ⏳ (15%)
   - `task_create`: Создание новой задачи ⏳ (10%)

5. **Команды для мониторинга**:
   - `monitor_chain`: Мониторинг выполнения конкретной цепочки ✅
   - `monitor_task`: Мониторинг выполнения конкретной задачи ✅
   - `monitor_usage`: Мониторинг использования API-ключей ⏳ (40%)

6. **Команды для управления чекпоинтами**:
   - `checkpoint_list`: Просмотр списка доступных чекпоинтов ✅
   - `checkpoint_get`: Получение содержимого чекпоинта ⏳ (40%)
   - `checkpoint_create`: Создание нового чекпоинта ⏳ (35%)
   - `checkpoint_delete`: Удаление чекпоинта ✅

#### 3.2.2. Визуализация в редакторе

Для улучшения пользовательского опыта в редакторах кода реализованы следующие визуальные компоненты:

1. **Диаграмма цепочки**:
   - Визуальное представление структуры цепочки моделей ⏳ (25%)
   - Отображение связей между моделями ⏳ (20%)
   - Цветовая индикация статуса каждой модели в цепочке ⏳ (30%)

   Пример:
   ```
   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
   │  Анализатор │ -> │ Суммаризатор│ -> │  Интегратор │
   │   (GPT-4)   │    │  (Claude-3) │    │ (DeepSeek)  │
   └─────────────┘    └─────────────┘    └─────────────┘
   ```

2. **Интерактивный монитор прогресса**:
   - Прогресс-бары для каждой модели в цепочке ✅
   - Отображение текущей задачи и её прогресса ✅
   - Время выполнения и оставшееся время ✅
   - Использование токенов и примерная стоимость ⏳ (40%)

3. **Панель результатов**:
   - Отображение промежуточных результатов ⏳ (40%)
   - Возможность сравнения результатов разных моделей ⏳ (20%)
   - Визуализация итоговых результатов ⏳ (35%)

### 3.3. Командный интерфейс

Адаптированы следующие команды claude-task-master для "Рикошет":

1. **Инициализация проекта:**
   ```
   ricochet-task init
   ```
   Статус: ✅ Завершено

2. **Парсинг большого документа:**
   ```
   ricochet-task chain run --chain "analyze-summarize-integrate" --input document.txt
   ```
   Статус: ✅ Завершено

3. **Проверка статуса задачи:**
   ```
   ricochet-task monitor chain --id 123
   ```
   Статус: ✅ Завершено

4. **Получение результата:**
   ```
   ricochet-task checkpoint get --id 123
   ```
   Статус: ✅ Завершено

5. **Управление ключами:**
   ```
   ricochet-task key add --provider openai --key "sk-..."
   ricochet-task key list
   ```
   Статус: ✅ Завершено

### 3.4. Интеграция системы выбора моделей

Task Master имеет мощный механизм интерактивного выбора моделей, который адаптирован для "Рикошет". Основные компоненты для интеграции:

#### 3.4.1. Структура конфигурации моделей

В Task Master конфигурация моделей хранится в файле `.taskmaster/config.json`:

```json
{
  "models": {
    "main": {
      "provider": "openrouter",
      "model": "deepseek/deepseek-chat-v3-0324",
      "temperature": 0.7
    },
    "research": {
      "provider": "perplexity",
      "model": "sonar",
      "temperature": 0.7
    },
    "fallback": {
      "provider": "openrouter",
      "model": "mistralai/mistral-small-3.1-24b-instruct",
      "temperature": 0.7
    }
  }
}
```

Для "Рикошет" структура расширена для поддержки специализированных ролей в цепочках:

```json
{
  "models": {
    "main": {
      "provider": "openrouter",
      "model": "deepseek/deepseek-chat-v3-0324",
      "temperature": 0.7
    },
    "research": {
      "provider": "perplexity",
      "model": "sonar",
      "temperature": 0.7
    },
    "fallback": {
      "provider": "openrouter",
      "model": "mistralai/mistral-small-3.1-24b-instruct",
      "temperature": 0.7
    },
    "roles": {
      "analyzer": {
        "provider": "anthropic",
        "model": "claude-3-opus",
        "temperature": 0.3
      },
      "summarizer": {
        "provider": "openai",
        "model": "gpt-4",
        "temperature": 0.5
      },
      "integrator": {
        "provider": "deepseek",
        "model": "deepseek-coder",
        "temperature": 0.7
      }
    }
  }
}
```

Статус: ✅ Базовая структура конфигурации реализована

#### 3.4.2. Интерактивный интерфейс выбора

Task Master использует библиотеку `inquirer` для создания интерактивного CLI-интерфейса. Для "Рикошет" реализован аналогичный интерфейс с использованием библиотеки `survey` для Go:

```go
package models

import (
    "github.com/AlecAivazis/survey/v2"
)

func SetupModels() error {
    // Получение списка доступных моделей
    providers, err := GetAvailableProviders()
    if err != nil {
        return err
    }
    
    // Создание опросов для каждой роли
    mainModelPrompt := &survey.Select{
        Message: "Выберите основную модель для генерации:",
        Options: providers.FormatOptions(),
    }
    
    // Аналогично для других ролей
    
    // Сохранение результатов в конфигурацию
    // ...
    
    return nil
}
```

Статус: ✅ Интерактивный CLI-интерфейс реализован

#### 3.4.3. MCP-команды для интеграции с редакторами

Аналогично Task Master, "Рикошет" предоставляет MCP-команды для управления моделями из редакторов кода:

```typescript
// В MCP-хендлере
async function handleModelsSetup(request, response) {
    // Получение доступных моделей
    const providers = await getAvailableProviders();
    
    // Отправка интерактивного меню в редактор
    const mainModel = await response.promptSelect({
        prompt: "Выберите основную модель для генерации:",
        options: providers.formatOptions()
    });
    
    // Аналогично для других ролей
    
    // Сохранение результатов
    await saveModelConfig({
        main: mainModel,
        // ...
    });
    
    return { success: true, message: "Настройка моделей завершена" };
}
```

Статус: ✅ Базовые MCP-команды для моделей реализованы

#### 3.4.4. Автоматический выбор моделей для ролей

В "Рикошет" при создании новой цепочки моделей система автоматически предлагает модели, соответствующие ролям:

```go
func SuggestModelForRole(role chain.ModelRole) (ModelConfig, error) {
    config, err := LoadModelConfig()
    if err != nil {
        return ModelConfig{}, err
    }
    
    // Попытка найти модель для указанной роли
    if roleConfig, ok := config.Roles[string(role)]; ok {
        return roleConfig, nil
    }
    
    // Если для роли нет специальной модели, использовать основную
    return config.Main, nil
}
```

Статус: ✅ Базовая функциональность реализована, ⏳ автоматический выбор по типу задачи в процессе (40%)

### 3.5. Система задач и их мониторинг

Адаптация системы задач из Task Master для "Рикошет" включает:

#### 3.5.1. Структура задачи в Ricochet

Каждая задача в Ricochet представлена в следующем формате:

```json
{
  "id": "task-123",
  "type": "model_execution",
  "title": "Анализ структуры документа",
  "description": "Анализ структуры входного документа с выделением ключевых тем",
  "status": "completed",
  "dependencies": ["task-122"],
  "model": {
    "provider": "openai",
    "name": "gpt-4",
    "role": "analyzer",
    "parameters": {
      "temperature": 0.3,
      "max_tokens": 2000
    }
  },
  "input": {
    "type": "text",
    "source": "checkpoint-122",
    "segment": 1
  },
  "output": {
    "type": "text",
    "destination": "checkpoint-123"
  },
  "metrics": {
    "tokens_input": 1456,
    "tokens_output": 834,
    "duration_ms": 2300,
    "cost": 0.032
  },
  "created_at": "2023-06-01T10:15:30Z",
  "started_at": "2023-06-01T10:15:31Z",
  "completed_at": "2023-06-01T10:15:33Z"
}
```

Статус: ✅ Базовая структура реализована, ⏳ интеграция с системой задач Task Master в процессе (30%)

#### 3.5.2. Система мониторинга задач

Система мониторинга в Ricochet предоставляет:

1. **Отслеживание статуса задач**:
   - Визуализация статуса каждой задачи в цепочке ✅
   - Обновление в реальном времени через WebSocket ⏳ (35%)
   - Уведомления о завершении или ошибках ⏳ (30%)

2. **Детальная аналитика**:
   - Время выполнения каждой задачи ✅
   - Использование токенов и стоимость ✅
   - Производительность разных моделей для аналогичных задач ⏳ (25%)

3. **Управление задачами**:
   - Приостановка и возобновление задач ✅
   - Перенаправление задач на другие модели ⏳ (40%)
   - Ручное создание чекпоинтов ✅

4. **Интеграция с редактором**:
   - Отображение статуса задач непосредственно в редакторе ✅
   - Привязка задач к конкретным файлам и участкам кода ⏳ (20%)
   - Генерация отчетов о выполнении ⏳ (15%)

#### 3.5.3. Визуализация прогресса задач

Для визуализации прогресса выполнения задач в CLI и редакторах используются интерактивные элементы:

```
Задача #123: Анализ структуры документа
┌───────────────────────────────────────────────────┐
│ Статус: ✅ Завершена                              │
│ Модель: OpenAI GPT-4 (Анализатор)                 │
│ Прогресс: [▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓] 100%       │
│ Время: 2.3с / 2.3с                                │
│ Токены: 1456 вход / 834 выход                     │
│ Стоимость: $0.032                                 │
└───────────────────────────────────────────────────┘

Зависимости:
 └── Задача #122: Сегментация документа ✅
```

Статус: ✅ Базовая визуализация реализована в CLI, ⏳ расширенная визуализация в редакторе в процессе (45%)

## 4. План внедрения

### Этап 1: Прототип интеграции - ВЫПОЛНЕНО НА 90%
- [x] Изучить исходный код claude-task-master для понимания архитектуры
- [x] Создать прототип хранения задач в формате, аналогичном claude-task-master
- [x] Реализовать базовые команды CLI, вдохновленные claude-task-master
- [x] **Создать прототип интерактивного выбора моделей на основе Task Master**

### Этап 2: Расширение возможностей - ВЫПОЛНЕНО НА 60%
- [x] Добавить поддержку MCP для интеграции с редакторами
- [ ] Реализовать визуализацию графа задач ⏳ (25%)
- [x] Создать расширенную документацию по использованию
- [ ] **Расширить механизм выбора моделей для поддержки специализированных ролей** ⏳ (60%)

### Этап 3: Полная интеграция - ВЫПОЛНЕНО НА 15%
- [ ] Разработать веб-интерфейс для управления задачами ⏳ (10%)
- [ ] Реализовать интеграцию с системами контроля версий ⏳ (5%)
- [ ] Добавить систему пользователей и разделение прав доступа ⏳ (20%)
- [ ] **Реализовать двустороннюю синхронизацию настроек моделей с Task Master** ⏳ (35%)

## 5. Примеры пользовательского взаимодействия

### Пример 1: Инициализация через MCP в редакторе

**Пользователь (в чате редактора)**: "Инициализируй Рикошет в моем проекте"

**Ассистент**:
```
Инициализирую Рикошет в вашем проекте...

✅ Создана структура директорий
✅ Настроены шаблоны цепочек
✅ Создан файл конфигурации .ricochet/config.yaml

Проект готов к использованию! Теперь вы можете:
1. Добавить API-ключи: `ricochet-task key add --provider openai`
2. Загрузить документ для обработки: `ricochet-task chain run --chain analyze-summarize --input document.txt`
```

Статус: ✅ Базовая функциональность реализована

### Пример 2: Обработка документа

**Пользователь (в чате редактора)**: "Обработай файл research.pdf с помощью цепочки 'анализ-резюме'"

**Ассистент**:
```
Создаю задачу для обработки файла research.pdf...

📋 Задача #123 создана
📊 Документ разбит на 5 сегментов
🔄 Цепочка "анализ-резюме" будет применена к каждому сегменту
⏳ Начинаю обработку...

Вы можете проверить статус командой `ricochet-task monitor chain --id 123`
```

Статус: ✅ Базовая функциональность реализована, ⏳ интеграция с MCP в процессе (45%)

### Пример 3: Настройка моделей для цепочки

**Пользователь (в чате редактора)**: "Настрой модели для работы с Рикошет"

**Ассистент**:
```
Запускаю интерактивную настройку моделей...

✅ Начинаю интерактивную настройку моделей

Выберите основную модель для генерации:
> ✓ anthropic / claude-3-sonnet
  openai / gpt-4-turbo
  deepseek / deepseek-coder
  mistral / mistral-large

Выберите модель для роли "Анализатор":
> ✓ anthropic / claude-3-opus
  openai / gpt-4-turbo
  openai / gpt-4o

Выберите модель для роли "Суммаризатор":
> ✓ openai / gpt-4o
  anthropic / claude-3-sonnet
  mistral / mistral-large

Выберите модель для роли "Интегратор":
> ✓ deepseek / deepseek-coder
  openai / gpt-4-turbo
  anthropic / claude-3-haiku

✅ Настройка моделей завершена!

Установленные модели:
- Основная: anthropic / claude-3-sonnet
- Анализатор: anthropic / claude-3-opus
- Суммаризатор: openai / gpt-4o
- Интегратор: deepseek / deepseek-coder

Теперь вы можете создавать цепочки с этими моделями.
```

Статус: ✅ Базовая функциональность в CLI реализована, ⏳ расширенный интерфейс в MCP в процессе (60%)

## 6. Текущий статус интеграции

### Завершенные компоненты:
- ✅ Базовая структура CLI-интерфейса по аналогии с Task Master
- ✅ Система управления API-ключами, адаптированная из Task Master
- ✅ Хранение чекпоинтов для сохранения промежуточных результатов
- ✅ Интерактивный выбор моделей через CLI
- ✅ Базовая интеграция с MCP для редакторов

### Компоненты в процессе реализации:
- ⏳ Расширенная интеграция с MCP (45%)
- ⏳ Интерактивный конструктор цепочек в редакторе (30%)
- ⏳ Интеграция с системой задач Task Master (30%)
- ⏳ Система ролей для моделей с автоматическим выбором (60%)
- ⏳ Синхронизация настроек между Task Master и Ricochet (35%)

### Запланированные компоненты:
- 🔜 Веб-интерфейс для управления задачами и цепочками
- 🔜 Система разделения прав доступа для совместной работы
- 🔜 Расширенная визуализация выполнения цепочек в редакторе
- 🔜 Интеграция с системами контроля версий

## 7. Выводы

Интеграция концепций claude-task-master в проект "Рикошет" позволяет значительно улучшить пользовательский опыт и функциональность системы:

1. **Улучшение пользовательского опыта** через интеграцию с редакторами кода
2. **Структурированное управление задачами** обработки больших документов
3. **Сохранение контекста** между сессиями работы
4. **Расширяемость через подключение различных LLM-провайдеров**

На текущий момент реализовано около 60% запланированной интеграции, что уже позволяет пользователям эффективно использовать основные функции системы. Дальнейшее развитие будет сосредоточено на углублении интеграции с редакторами кода и расширении функциональности системы управления задачами. 