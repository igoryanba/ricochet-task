# Интеграция Ricochet Task с существующей архитектурой

Этот документ описывает детали интеграции CLI-инструмента Ricochet Task с существующей инфраструктурой GRIK AI.

## Текущий статус интеграции

| Компонент | Статус | Комментарий |
|-----------|--------|-------------|
| CLI-инструмент | ✅ Завершено | Базовый функционал полностью реализован |
| API-клиент | ✅ Завершено | Поддержка OpenAI, Claude, DeepSeek |
| Ядро оркестратора | ✅ Завершено | Базовая поддержка цепочек и сегментации |
| Система чекпоинтов | ✅ Завершено | Реализовано хранение в файловой системе |
| Система API-ключей | ✅ Завершено | Адаптирована из Task Master |
| MCP-интеграция | ⏳ В процессе | Реализовано 45% функциональности |
| Интерактивный выбор моделей | ⏳ В процессе | Базовый интерфейс реализован (60%) |

## Архитектурная схема

```
┌──────────────────────────────────────────┐
│                                          │
│          Ricochet Task CLI               │
│                                          │
└───────────────────┬──────────────────────┘
                    │
                    ▼
┌──────────────────────────────────────────┐
│                                          │
│             API Gateway                  │
│                                          │
└───┬──────────────────┬───────────────┬───┘
    │                  │               │
    ▼                  ▼               ▼
┌─────────┐      ┌──────────┐     ┌─────────┐
│         │      │          │     │         │
│ Model   │      │ Data     │     │ Ricochet│
│ Services│      │ Service  │     │ Service │
│         │      │          │     │         │
└─────────┘      └──────────┘     └─────────┘
```

## Взаимодействие с компонентами

### 1. API Gateway

Ricochet Task взаимодействует с существующим API Gateway для доступа ко всем сервисам. Преимущества этого подхода:

- Единая точка входа для всех сервисов
- Унифицированная аутентификация и авторизация
- Централизованное логирование и мониторинг

Используемые эндпоинты API Gateway:
- `/api/models` - получение списка доступных моделей
- `/api/chat/completions` - взаимодействие с моделями
- `/api/data/*` - доступ к данным пользователя
- `/api/ricochet/*` - специфичные для Ricochet эндпоинты

### 2. Model Services

Ricochet Task использует существующие сервисы моделей через API Gateway:

- OpenAI Service ✅
- Anthropic Service ✅
- DeepSeek Service ✅
- Grok Service ⏳
- Mistral Service ⏳

Сервисы моделей не требуют изменений для интеграции с Ricochet Task.

### 3. Data Service

Data Service используется для:

- Управления квотами и лимитами
- Хранения метаданных цепочек и чекпоинтов
- Аутентификации и управления API-ключами

Статус интеграции с Data Service:
- Модель Chain (цепочка моделей) ✅
- Модель Checkpoint (чекпоинт) ✅
- API для управления цепочками и чекпоинтами ✅

### 4. Ricochet Service

Новый микросервис для:
- Оркестрации цепочек моделей ✅
- Сегментации больших текстов ✅
- Маршрутизации между моделями ✅
- Обработки чекпоинтов ✅

Ricochet Service взаимодействует с сервисами моделей через API Gateway.

## Аутентификация и авторизация

Ricochet Task использует ту же систему аутентификации, что и остальные компоненты:

1. Пользователь получает API-ключ через существующий механизм ✅
2. API-ключ хранится локально в зашифрованном виде ✅
3. API-ключ передается в заголовке Authorization для всех запросов ✅

## Хранение данных

### Локальное хранение:
- Конфигурация (config.json) ✅
- API-ключи (зашифрованные) ✅
- Кэш метаданных цепочек и чекпоинтов ✅

### Серверное хранение:
- Метаданные цепочек и чекпоинтов (PostgreSQL) ⏳
- Содержимое чекпоинтов (MinIO или локальная файловая система) ✅

## Интеграция с MCP (Model Control Protocol)

Для интеграции с редакторами кода Ricochet Task предоставляет MCP-сервер:

```json
// ~/.cursor/mcp.json
{
  "mcpServers": {
    "ricochet-ai": {
      "command": "ricochet-task",
      "args": ["mcp"],
      "env": {
        "RICOCHET_API_KEY": "YOUR_API_KEY_HERE"
      }
    }
  }
}
```

Статус MCP-интеграции:
- Базовый MCP-сервер ✅
- Базовые команды для взаимодействия с цепочками ✅
- Команды для управления моделями ✅
- Интерактивное создание цепочек ⏳
- Мониторинг выполнения ✅
- Просмотр чекпоинтов ⏳
- Интеграция с редактором кода ⏳

## План интеграции

1. Разработка CLI-инструмента Ricochet Task с базовыми функциями ✅
2. Добавление необходимых моделей и эндпоинтов в Data Service ✅
3. Разработка Ricochet Service как отдельного микросервиса ✅
4. Настройка маршрутизации в API Gateway ✅
5. Интеграция с MCP для редакторов кода ⏳ (45%)

## Зависимости

1. Go 1.21+ ✅
2. Существующая инфраструктура GRIK AI:
   - API Gateway ✅
   - Model Services ✅
   - Data Service ✅
   - PostgreSQL ⏳
   - MinIO (опционально) ⏳

## Безопасность

- Все API-ключи хранятся локально в зашифрованном виде ✅
- Все коммуникации используют HTTPS ✅
- Авторизация на уровне API Gateway ✅
- Квоты и лимиты управляются через Data Service ⏳

## Интеграция механизма выбора моделей из Task Master

### Принцип работы в Task Master

Task Master использует интерактивный механизм выбора моделей, который позволяет пользователю:
1. Выбирать основную модель для генерации контента и обновлений
2. Выбирать исследовательскую модель для анализа и изучения данных
3. Выбирать резервную модель, которая используется в случае недоступности основной

Процесс выбора моделей интерактивный, с использованием CLI-интерфейса или MCP-команд в редакторе кода:

```
Starting interactive model setup...
? Select the main model for generation/updates:
❯ ✔ No change to current main model (deepseek/deepseek-chat-v3-0324:free)
  ⏹ Cancel Model Setup
  * Custom OpenRouter model
  * Custom Ollama model
  * Custom Bedrock model
 ──────────────
  anthropic / claude-sonnet-4-20250514
```

### Статус адаптации для Ricochet Task

1. **Расширенный выбор ролей моделей**: ⏳ В процессе (60%)
   - Основная модель (генерация, обновления) ✅
   - Исследовательская модель (анализ данных) ✅
   - Резервная модель (fallback) ✅
   - Модель-анализатор (роль в цепочке) ✅
   - Модель-суммаризатор (роль в цепочке) ✅
   - Модель-интегратор (роль в цепочке) ✅
   - Другие специализированные роли ⏳

2. **Интерфейсы выбора моделей**: ⏳ В процессе (70%)
   - CLI-команда `ricochet models setup` для интерактивного выбора ✅
   - MCP-команда `models_setup` для выбора моделей в редакторе кода ✅
   - MCP-команда `models_list` для просмотра настроенных моделей ✅
   - Визуализация выбора моделей в редакторе ⏳
   - Веб-интерфейс для выбора моделей (в будущих версиях) ⏳

3. **Хранение настроек моделей**: ✅ Базовая реализация (95%)
   - Локальная конфигурация в файле `.ricochet/models.json` ✅
   - Совместимость с форматом Task Master для переиспользования настроек ✅
   - Шифрование чувствительных данных ✅
   - Синхронизация настроек между проектами ✅

4. **Интерактивный процесс выбора**: ✅ Реализовано (95%)
   ```
   $ ricochet models setup
   ? Выберите основную модель для генерации:
   ❯ openai / gpt-4-turbo
     anthropic / claude-3-sonnet
     deepseek / deepseek-coder
     mistral / mistral-large
     // ... другие модели
   
   ? Выберите модель для роли анализатора:
   ❯ anthropic / claude-3-opus
     openai / gpt-4-turbo
     // ... другие модели
   
   // ... и т.д. для других ролей
   ```

5. **Автоматическое использование моделей в цепочках**: ⏳ В процессе (80%)
   - При создании цепочки предлагаются модели, соответствующие ролям ✅
   - Возможность переопределить модель для конкретной цепочки ✅
   - Динамическое переключение моделей при необходимости ✅
   - Фолбэк на альтернативные модели при недоступности основной ✅
   - Система оценки эффективности моделей для ролей ⏳

### Техническая реализация

1. **Модуль управления моделями** (`pkg/models`): ✅ Базовая реализация (90%)
   - Структуры данных для хранения настроек моделей ✅
   - Функции для загрузки и сохранения настроек ✅
   - Интерфейсы для выбора моделей в CLI ✅
   - Интерфейсы для выбора моделей в MCP ✅
   - Механизмы валидации конфигураций ✅
   - Система приоритетов и фолбэка ✅

2. **Интеграция с цепочками**: ✅ Базовая реализация (85%)
   - Связь между ролями в цепочке и настроенными моделями ✅
   - Автоматический выбор модели по роли при создании цепочки ✅
   - Приоритезация моделей (пользовательский выбор > роль по умолчанию > резервная модель) ✅
   - Пересоздание цепочек с новыми моделями ✅
   - Динамическая подстановка моделей во время выполнения ⏳

3. **Совместимость с Task Master**: ⏳ В процессе (75%)
   - Конвертеры между форматами настроек Task Master и Ricochet Task ✅
   - Возможность импорта настроек из Task Master ✅
   - Возможность экспорта настроек в Task Master ✅
   - Общий набор поддерживаемых провайдеров и моделей ✅
   - Синхронизация настроек между проектами ⏳
   - Автоматическое обновление настроек при изменениях в Task Master ⏳

### Новые компоненты для добавления

1. **Система приоритезации моделей**:
   - Механизм оценки доступности моделей ✅
   - Автоматическое переключение на резервные модели при проблемах ✅
   - Сохранение статистики использования моделей ⏳
   - Оценка производительности моделей для разных ролей ⏳

2. **Расширенный интерфейс в MCP**:
   - Визуальное представление моделей для ролей ⏳
   - Интерактивное редактирование настроек в редакторе ✅
   - Статистика использования моделей в редакторе ⏳
   - Рекомендации по выбору моделей на основе задач ⏳

3. **Интеграция с системой задач**:
   - Автоматический выбор моделей на основе типа задачи ✅
   - Адаптивное распределение задач между моделями ⏳
   - Отслеживание эффективности моделей для разных типов задач ⏳
   - Машинное обучение для оптимизации выбора моделей ⏳

### Команды MCP для управления моделями

Для интеграции с редакторами кода реализованы следующие MCP-команды:

1. `models_setup`: Интерактивный выбор моделей ✅
   ```json
   {
     "command": "models_setup",
     "params": {
       "roles": ["main", "research", "fallback", "analyzer", "summarizer"]
     }
   }
   ```

2. `models_list`: Просмотр настроенных моделей ✅
   ```json
   {
     "command": "models_list",
     "params": {}
   }
   ```

3. `models_set`: Установка конкретной модели для роли ✅
   ```json
   {
     "command": "models_set",
     "params": {
       "role": "analyzer",
       "provider": "anthropic",
       "model": "claude-3-opus",
       "parameters": {
         "temperature": 0.3
       }
     }
   }
   ```

4. `models_reset`: Сброс настроек моделей к значениям по умолчанию ✅
   ```json
   {
     "command": "models_reset",
     "params": {
       "roles": ["all"] // или конкретные роли ["main", "analyzer"]
     }
   }
   ```

5. `models_import`: Импорт настроек моделей из Task Master ✅
   ```json
   {
     "command": "models_import",
     "params": {
       "source": "taskmaster" // или путь к файлу конфигурации
     }
   }
   ```

6. `models_export`: Экспорт настроек моделей для использования в Task Master ✅
   ```json
   {
     "command": "models_export",
     "params": {
       "destination": "taskmaster" // или путь для сохранения файла
     }
   }
   ```

# Интеграция с Task Master

Данный документ описывает особенности и механизмы интеграции Ricochet Task с инструментом Task Master для управления задачами AI-ассистентов.

## Цели интеграции

1. **Совместимость управления моделями** - Единая система настройки и выбора моделей для обоих инструментов.
2. **Взаимодополняющий функционал** - Использование сильных сторон обоих инструментов в едином рабочем процессе.
3. **Единообразие пользовательского опыта** - Схожие интерфейсы и команды для снижения кривой обучения.
4. **Кроссплатформенная интеграция** - Работа в различных редакторах кода через MCP (Model Control Protocol).

## Текущий статус интеграции

| Компонент | Статус | Прогресс |
|-----------|--------|----------|
| Управление API-ключами | ✅ Завершено | 100% |
| Интерактивный выбор моделей | ⏳ В процессе | 60% |
| Синхронизация настроек | ⏳ В процессе | 35% |
| Интеграция с MCP | ⏳ В процессе | 45% |
| Общий API для задач | ⏳ В процессе | 30% |
| Совместный рабочий процесс | 🔜 Запланировано | 0% |

## Ключевые компоненты интеграции

### 1. Система управления API-ключами

Реализована совместимая система управления API-ключами для различных LLM-провайдеров:

- Общий формат хранения ключей
- Схожие команды для управления ключами
- Возможность использования одних и тех же ключей в обоих инструментах
- Шифрование ключей с помощью одинаковых алгоритмов

**Пример использования:**

```bash
# В Task Master
task-master models --setup

# В Ricochet Task
ricochet-task key add --provider anthropic --key "sk-..." --shared
```

### 2. Интерактивный выбор моделей

Реализован схожий интерактивный интерфейс для выбора моделей:

- Аналогичная структура конфигурации моделей
- Единообразные роли моделей (основная, исследовательская, резервная)
- Совместимые команды для настройки моделей
- Возможность синхронизации выбранных моделей между инструментами

**Пример выбора моделей в Ricochet Task (интерактивный режим):**

```
🤖 Настройка моделей для различных ролей

Выберите основную модель для генерации:
> ✓ anthropic / claude-3-sonnet
  openai / gpt-4-turbo
  deepseek / deepseek-coder
  mistral / mistral-large

Выберите исследовательскую модель:
> ✓ perplexity / sonar
  anthropic / claude-3-opus
  openai / gpt-4o

Выберите резервную модель:
> ✓ openai / gpt-3.5-turbo
  anthropic / claude-3-haiku
  mistral / mistral-small
```

### 3. Интеграция с MCP

Реализована интеграция с MCP (Model Control Protocol) для работы в редакторах кода:

- Совместимая структура MCP-серверов
- Аналогичные команды для взаимодействия с редактором
- Возможность параллельной работы обоих инструментов в одном редакторе
- Единообразные форматы вывода и визуализации

**Пример конфигурации MCP для работы обоих инструментов:**

```json
{
  "mcpServers": {
    "taskmaster": {
      "command": "task-master",
      "args": ["mcp"],
      "env": {
        "ANTHROPIC_API_KEY": "${env:ANTHROPIC_API_KEY}",
        "OPENAI_API_KEY": "${env:OPENAI_API_KEY}"
      }
    },
    "ricochet": {
      "command": "ricochet-task",
      "args": ["mcp"],
      "env": {
        "ANTHROPIC_API_KEY": "${env:ANTHROPIC_API_KEY}",
        "OPENAI_API_KEY": "${env:OPENAI_API_KEY}"
      }
    }
  }
}
```

### 4. Общий формат задач

Разрабатывается совместимый формат для представления задач:

- Единая структура задач с общими полями (id, title, description, status, dependencies)
- Расширенные поля для специфичных нужд каждого инструмента
- Возможность преобразования задач между форматами инструментов
- Поддержка вложенных задач и зависимостей

**Сравнение форматов задач:**

**Task Master:**
```json
{
  "id": "1",
  "title": "Implement user authentication",
  "description": "Create user authentication system using JWT",
  "status": "pending",
  "dependencies": ["3"],
  "priority": "high",
  "details": "Use JWT for token generation, include refresh tokens",
  "testStrategy": "Unit tests for token generation and validation"
}
```

**Ricochet Task:**
```json
{
  "id": "task-1",
  "type": "model_execution",
  "title": "Analyze document structure",
  "description": "Analyze the structure of the input document",
  "status": "completed",
  "dependencies": ["task-2"],
  "model": {
    "provider": "openai",
    "name": "gpt-4",
    "role": "analyzer",
    "parameters": {
      "temperature": 0.3,
      "max_tokens": 2000
    }
  },
  "input": {
    "type": "text",
    "source": "checkpoint-2",
    "segment": 1
  },
  "output": {
    "type": "text",
    "destination": "checkpoint-1"
  }
}
```

### 5. Синхронизация настроек

Реализована возможность синхронизации настроек между инструментами:

- Импорт настроек моделей из Task Master в Ricochet Task
- Автоматическое обнаружение настроек Task Master
- Возможность выборочной синхронизации
- Работа с одной и той же базой API-ключей

**Пример синхронизации настроек:**

```bash
# Синхронизация настроек из Task Master
ricochet-task models sync --from-taskmaster --path="/path/to/project/.taskmaster"
```

### 6. Шаблоны рабочих процессов

Разрабатываются шаблоны для совместного использования обоих инструментов:

- Task Master для управления задачами проекта и планирования
- Ricochet Task для обработки больших объемов данных и сложных цепочек моделей
- Интеграция результатов Ricochet Task в задачи Task Master
- Автоматическое создание задач в Task Master на основе результатов Ricochet Task

## Практические сценарии интеграции

### Сценарий 1: Анализ и рефакторинг большого проекта

1. **Использование Task Master для планирования:**
   - Парсинг PRD для создания структуры задач: `task-master parse-prd --input=prd.txt`
   - Анализ сложности проекта: `task-master analyze-complexity --research`
   - Разбиение задач на подзадачи: `task-master expand --id=5 --research`

2. **Использование Ricochet Task для обработки кода:**
   - Анализ кодовой базы: `ricochet-task chain run --chain "code-analyzer" --input="src/"`
   - Получение рекомендаций: `ricochet-task checkpoint get --id=last --format=markdown`

3. **Интеграция результатов:**
   - Обновление задач в Task Master: `task-master update-task --id=5 --prompt="Результаты анализа кода..."`
   - Продолжение работы с Task Master: `task-master next`

### Сценарий 2: Работа над исследовательским проектом

1. **Управление исследованием с помощью Task Master:**
   - Создание структуры исследования: `task-master init --name="Research Project"`
   - Добавление задач: `task-master add-task --prompt="Research prior work"`

2. **Анализ литературы с помощью Ricochet Task:**
   - Настройка моделей для исследования: `ricochet-task models setup`
   - Создание цепочки для анализа: `ricochet-task chain create --name="literature-review"`
   - Обработка научных статей: `ricochet-task chain run --chain="literature-review" --input="papers/"`

3. **Интеграция результатов в Task Master:**
   - Обновление исследовательских задач: `task-master update-task --id=2 --prompt="Findings from literature review..."`

### Сценарий 3: Интеграция через MCP в редакторе кода

1. **Инициализация проектов:**
   - В чате редактора: "Initialize Task Master in this project"
   - В чате редактора: "Initialize Ricochet Task in this project"

2. **Создание и выполнение задач:**
   - В чате: "Break down this project into tasks" (использует Task Master)
   - В чате: "Analyze this codebase using GPT-4" (использует Ricochet Task)

3. **Мониторинг выполнения:**
   - В интерфейсе редактора отображаются прогресс-бары для обоих инструментов
   - Результаты работы Ricochet Task автоматически добавляются в Task Master

## Будущие направления интеграции

### Запланированные возможности:

1. **Единый CLI-интерфейс:**
   - Объединение команд обоих инструментов под общим интерфейсом
   - Умное определение контекста для выбора подходящего инструмента
   - Алиасы для частых комбинаций команд

2. **Веб-интерфейс:**
   - Единая панель управления для обоих инструментов
   - Визуализация связей между задачами и цепочками моделей
   - Интерактивные диаграммы и графики для анализа производительности

3. **Интеграция с CI/CD:**
   - Автоматический запуск цепочек моделей при изменении кода
   - Обновление статуса задач в Task Master на основе результатов CI/CD
   - Генерация отчетов о производительности моделей

4. **Расширенная интеграция с редакторами:**
   - Встроенные панели для управления задачами и цепочками
   - Интерактивные подсказки от моделей прямо в коде
   - Автоматическое обновление задач при изменении кода

## Рекомендации по совместному использованию

### Когда использовать Task Master:

- Для планирования и структурирования проектов
- Для отслеживания зависимостей между задачами
- Для пошагового выполнения сложных разработок
- Для работы с кодом через MCP

### Когда использовать Ricochet Task:

- Для обработки больших объемов данных
- Для создания сложных цепочек моделей
- Для анализа и генерации больших документов
- Для задач, требующих комбинирования различных моделей

### Оптимальный подход:

- Используйте Task Master для управления проектом и задачами
- Используйте Ricochet Task для сложных задач обработки данных
- Интегрируйте результаты Ricochet Task в задачи Task Master
- Синхронизируйте настройки моделей между инструментами

## Конфигурация для совместной работы

### Оптимальная структура проекта:

```
project/
├── .taskmaster/          # Конфигурация Task Master
│   ├── config.json       # Настройки Task Master
│   ├── tasks/            # Задачи Task Master
│   └── reports/          # Отчеты Task Master
├── .ricochet/            # Конфигурация Ricochet Task
│   ├── config.yaml       # Настройки Ricochet Task
│   ├── chains/           # Цепочки моделей
│   └── checkpoints/      # Чекпоинты моделей
├── .cursor/              # Конфигурация редактора
│   └── mcp.json          # Настройки MCP для обоих инструментов
└── src/                  # Исходный код проекта
```

### Пример общей конфигурации MCP:

```json
{
  "mcpServers": {
    "taskmaster": {
      "command": "task-master",
      "args": ["mcp"],
      "env": {
        "ANTHROPIC_API_KEY": "${env:ANTHROPIC_API_KEY}",
        "OPENAI_API_KEY": "${env:OPENAI_API_KEY}",
        "PERPLEXITY_API_KEY": "${env:PERPLEXITY_API_KEY}",
        "TASKMASTER_LOG_LEVEL": "info"
      }
    },
    "ricochet": {
      "command": "ricochet-task",
      "args": ["mcp"],
      "env": {
        "ANTHROPIC_API_KEY": "${env:ANTHROPIC_API_KEY}",
        "OPENAI_API_KEY": "${env:OPENAI_API_KEY}",
        "PERPLEXITY_API_KEY": "${env:PERPLEXITY_API_KEY}",
        "RICOCHET_LOG_LEVEL": "info"
      }
    }
  }
}
```

## Заключение

Интеграция Ricochet Task с Task Master создает мощную комбинацию инструментов для работы с AI-моделями. Task Master обеспечивает структурированный подход к управлению задачами, а Ricochet Task добавляет возможность создания сложных цепочек моделей для обработки больших объемов данных.

На текущий момент реализовано около 45% запланированной интеграции, что уже позволяет эффективно использовать оба инструмента вместе. Дальнейшее развитие интеграции будет направлено на создание более тесной связи между инструментами и улучшение пользовательского опыта. 