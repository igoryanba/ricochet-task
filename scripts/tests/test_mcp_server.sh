#!/bin/bash
# test_mcp_server.sh - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ MCP —Å–µ—Ä–≤–µ—Ä–∞

echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ MCP —Å–µ—Ä–≤–µ—Ä–∞..."

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
log_result() {
    local test_name="$1"
    local result="$2"
    local message="$3"
    
    if [ "$result" = "success" ]; then
        echo "   ‚úÖ $test_name: $message"
    else
        echo "   ‚ùå $test_name: $message"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Ä—Ç–∞
check_port() {
    local port="$1"
    if netstat -an 2>/dev/null | grep -q ":$port "; then
        return 0
    else
        return 1
    fi
}

# –¢–µ—Å—Ç 1: –ó–∞–ø—É—Å–∫ MCP —Å–µ—Ä–≤–µ—Ä–∞
echo "1. –ó–∞–ø—É—Å–∫ MCP —Å–µ—Ä–≤–µ—Ä–∞..."
./scripts/start-mcp.sh
sleep 3

if check_port 8091; then
    log_result "–ó–∞–ø—É—Å–∫ MCP —Å–µ—Ä–≤–µ—Ä–∞" "success" "–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8091"
else
    log_result "–ó–∞–ø—É—Å–∫ MCP —Å–µ—Ä–≤–µ—Ä–∞" "error" "–°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    exit 1
fi

# –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ MCP —Å–µ—Ä–≤–µ—Ä–∞..."
if ./scripts/status-mcp.sh > /dev/null 2>&1; then
    log_result "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞" "success" "–°—Ç–∞—Ç—É—Å –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ"
else
    log_result "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞" "error" "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞"
fi

# –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
echo "3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è MCP —Å–µ—Ä–≤–µ—Ä–∞..."
if curl -s http://localhost:8091/health > /dev/null 2>&1; then
    log_result "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è" "success" "–°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ health check"
else
    log_result "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è" "error" "–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ health check"
fi

# –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
echo "4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤..."
if curl -s http://localhost:8091/tools > /dev/null 2>&1; then
    log_result "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤" "success" "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã"
else
    log_result "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤" "error" "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
fi

# –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ JSON –æ—Ç–≤–µ—Ç–∞
echo "5. –ü—Ä–æ–≤–µ—Ä–∫–∞ JSON –æ—Ç–≤–µ—Ç–∞..."
if curl -s http://localhost:8091/tools | jq . > /dev/null 2>&1; then
    log_result "–ü—Ä–æ–≤–µ—Ä–∫–∞ JSON" "success" "JSON –æ—Ç–≤–µ—Ç –≤–∞–ª–∏–¥–µ–Ω"
else
    log_result "–ü—Ä–æ–≤–µ—Ä–∫–∞ JSON" "error" "JSON –æ—Ç–≤–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–µ–Ω"
fi

# –¢–µ—Å—Ç 6: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
echo "6. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ MCP —Å–µ—Ä–≤–µ—Ä–∞..."
./scripts/stop-mcp.sh
sleep 2

if ! check_port 8091; then
    log_result "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞" "success" "–°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
else
    log_result "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞" "error" "–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ MCP —Å–µ—Ä–≤–µ—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
