# Интеграция Ricochet Task с существующей архитектурой

Этот документ описывает детали интеграции CLI-инструмента Ricochet Task с существующей инфраструктурой GRIK AI.

## Текущий статус интеграции

| Компонент | Статус | Комментарий |
|-----------|--------|-------------|
| CLI-инструмент | ✅ Завершено | Базовый функционал полностью реализован |
| API-клиент | ✅ Завершено | Поддержка OpenAI, Claude, DeepSeek |
| Ядро оркестратора | ✅ Завершено | Базовая поддержка цепочек и сегментации |
| Система чекпоинтов | ✅ Завершено | Реализовано хранение в файловой системе |
| Система API-ключей | ✅ Завершено | Адаптирована из Task Master |
| MCP-интеграция | ⏳ В процессе | Базовая поддержка протокола реализована |
| Интерактивный выбор моделей | ⏳ В процессе | Базовая структура адаптирована из Task Master |
|Система управления задачами | ✅ Завершено | Реализована полностью нативная версия |
| Структура данных задач | ✅ Завершено | Оптимизирована для нужд Ricochet Task |
| Система статусов | ✅ Завершено | Включает все необходимые статусы для задач |
| Управление зависимостями | ✅ Завершено | Поддержка отношений между задачами |
| CLI-интерфейс | ✅ Завершено | Команды для управления задачами |
| Интерактивный выбор моделей | ✅ Завершено | Собственная реализация выбора моделей |

## Архитектурная схема

```
┌──────────────────────────────────────────┐
│                                          │
│          Ricochet Task CLI               │
│                                          │
└───────────────────┬──────────────────────┘
                    │
                    ▼
┌──────────────────────────────────────────┐
│                                          │
│             API Gateway                  │
│                                          │
└───┬──────────────────┬───────────────┬───┘
    │                  │               │
    ▼                  ▼               ▼
┌─────────┐      ┌──────────┐     ┌─────────┐
│         │      │          │     │         │
│ Model   │      │ Data     │     │ Ricochet│
│ Services│      │ Service  │     │ Service │
│         │      │          │     │         │
└─────────┘      └──────────┘     └─────────┘
```

## Взаимодействие с компонентами

### 1. API Gateway

Ricochet Task взаимодействует с существующим API Gateway для доступа ко всем сервисам. Преимущества этого подхода:

- Единая точка входа для всех сервисов
- Унифицированная аутентификация и авторизация
- Централизованное логирование и мониторинг

Используемые эндпоинты API Gateway:
- `/api/models` - получение списка доступных моделей
- `/api/chat/completions` - взаимодействие с моделями
- `/api/data/*` - доступ к данным пользователя
- `/api/ricochet/*` - специфичные для Ricochet эндпоинты

### 2. Model Services

Ricochet Task использует существующие сервисы моделей через API Gateway:

- OpenAI Service ✅
- Anthropic Service ✅
- DeepSeek Service ✅
- Grok Service ⏳
- Mistral Service ⏳

Сервисы моделей не требуют изменений для интеграции с Ricochet Task.

### 3. Data Service

Data Service используется для:

- Управления квотами и лимитами
- Хранения метаданных цепочек и чекпоинтов
- Аутентификации и управления API-ключами

Статус интеграции с Data Service:
- Модель Chain (цепочка моделей) ✅
- Модель Checkpoint (чекпоинт) ✅
- API для управления цепочками и чекпоинтами ✅

### 4. Ricochet Service

Новый микросервис для:
- Оркестрации цепочек моделей ✅
- Сегментации больших текстов ✅
- Маршрутизации между моделями ✅
- Обработки чекпоинтов ✅

Ricochet Service взаимодействует с сервисами моделей через API Gateway.

## Аутентификация и авторизация

Ricochet Task использует ту же систему аутентификации, что и остальные компоненты:

1. Пользователь получает API-ключ через существующий механизм ✅
2. API-ключ хранится локально в зашифрованном виде ✅
3. API-ключ передается в заголовке Authorization для всех запросов ✅

## Хранение данных

### Локальное хранение:
- Конфигурация (config.json) ✅
- API-ключи (зашифрованные) ✅
- Кэш метаданных цепочек и чекпоинтов ✅

### Серверное хранение:
- Метаданные цепочек и чекпоинтов (PostgreSQL) ⏳
- Содержимое чекпоинтов (MinIO или локальная файловая система) ✅

## Интеграция с MCP (Model Control Protocol)

Для интеграции с редакторами кода Ricochet Task предоставляет MCP-сервер:

```json
// ~/.cursor/mcp.json
{
  "mcpServers": {
    "ricochet-ai": {
      "command": "ricochet-task",
      "args": ["mcp"],
      "env": {
        "RICOCHET_API_KEY": "YOUR_API_KEY_HERE"
      }
    }
  }
}
```

Статус MCP-интеграции:
- Базовый MCP-сервер ✅
- Интерактивное создание цепочек ⏳
- Мониторинг выполнения ⏳
- Просмотр чекпоинтов ⏳
- Интеграция с редактором кода ⏳

## План интеграции

1. Разработка CLI-инструмента Ricochet Task с базовыми функциями ✅
2. Добавление необходимых моделей и эндпоинтов в Data Service ✅
3. Разработка Ricochet Service как отдельного микросервиса ✅
4. Настройка маршрутизации в API Gateway ✅
5. Интеграция с MCP для редакторов кода ⏳

## Зависимости

1. Go 1.21+ ✅
2. Существующая инфраструктура GRIK AI:
   - API Gateway ✅
   - Model Services ✅
   - Data Service ✅
   - PostgreSQL ⏳
   - MinIO (опционально) ⏳

## Безопасность

- Все API-ключи хранятся локально в зашифрованном виде ✅
- Все коммуникации используют HTTPS ✅
- Авторизация на уровне API Gateway ✅
- Квоты и лимиты управляются через Data Service ⏳

## Интеграция механизма выбора моделей из Task Master

### Принцип работы в Task Master

Task Master использует интерактивный механизм выбора моделей, который позволяет пользователю:
1. Выбирать основную модель для генерации контента и обновлений
2. Выбирать исследовательскую модель для анализа и изучения данных
3. Выбирать резервную модель, которая используется в случае недоступности основной

Процесс выбора моделей интерактивный, с использованием CLI-интерфейса или MCP-команд в редакторе кода:

```
Starting interactive model setup...
? Select the main model for generation/updates:
❯ ✔ No change to current main model (deepseek/deepseek-chat-v3-0324:free)
  ⏹ Cancel Model Setup
  * Custom OpenRouter model
  * Custom Ollama model
  * Custom Bedrock model
 ──────────────
  anthropic / claude-sonnet-4-20250514
```

### Статус адаптации для Ricochet Task

1. **Расширенный выбор ролей моделей**: ⏳ В процессе (45%)
   - Основная модель (генерация, обновления) ✅
   - Исследовательская модель (анализ данных) ✅
   - Резервная модель (fallback) ✅
   - Модель-анализатор (роль в цепочке) ✅
   - Модель-суммаризатор (роль в цепочке) ✅
   - Модель-интегратор (роль в цепочке) ⏳
   - Другие специализированные роли ⏳

2. **Интерфейсы выбора моделей**: ⏳ В процессе (40%)
   - CLI-команда `ricochet models setup` для интерактивного выбора ✅
   - MCP-команда `models_setup` для выбора моделей в редакторе кода ✅
   - Визуализация выбора моделей в редакторе ⏳
   - Веб-интерфейс для выбора моделей (в будущих версиях) ⏳

3. **Хранение настроек моделей**: ✅ Базовая реализация (90%)
   - Локальная конфигурация в файле `.ricochet/models.json` ✅
   - Совместимость с форматом Task Master для переиспользования настроек ✅
   - Шифрование чувствительных данных ✅
   - Синхронизация настроек между проектами (опционально) ⏳

4. **Интерактивный процесс выбора**: ✅ Реализовано (85%)
   ```
   $ ricochet models setup
   ? Выберите основную модель для генерации:
   ❯ openai / gpt-4-turbo
     anthropic / claude-3-sonnet
     deepseek / deepseek-coder
     mistral / mistral-large
     // ... другие модели
   
   ? Выберите модель для роли анализатора:
   ❯ anthropic / claude-3-opus
     openai / gpt-4-turbo
     // ... другие модели
   
   // ... и т.д. для других ролей
   ```

5. **Автоматическое использование моделей в цепочках**: ⏳ В процессе (60%)
   - При создании цепочки предлагаются модели, соответствующие ролям ✅
   - Возможность переопределить модель для конкретной цепочки ✅
   - Динамическое переключение моделей при необходимости ⏳
   - Фолбэк на альтернативные модели при недоступности основной ✅

### Техническая реализация

1. **Модуль управления моделями** (`pkg/models`): ✅ Базовая реализация (85%)
   - Структуры данных для хранения настроек моделей ✅
   - Функции для загрузки и сохранения настроек ✅
   - Интерфейсы для выбора моделей в CLI ✅
   - Интерфейсы для выбора моделей в MCP ✅
   - Механизмы валидации конфигураций ✅

2. **Интеграция с цепочками**: ✅ Базовая реализация (75%)
   - Связь между ролями в цепочке и настроенными моделями ✅
   - Автоматический выбор модели по роли при создании цепочки ✅
   - Приоритезация моделей (пользовательский выбор > роль по умолчанию > резервная модель) ✅
   - Пересоздание цепочек с новыми моделями ⏳

3. **Совместимость с Task Master**: ⏳ В процессе (50%)
   - Конвертеры между форматами настроек Task Master и Ricochet Task ✅
   - Возможность импорта настроек из Task Master ✅
   - Возможность экспорта настроек в Task Master ⏳
   - Общий набор поддерживаемых провайдеров и моделей ✅
   - Синхронизация настроек между проектами ⏳

### Новые компоненты для добавления

1. **Система приоритезации моделей**:
   - Механизм оценки доступности моделей ⏳
   - Автоматическое переключение на резервные модели при проблемах ⏳
   - Сохранение статистики использования моделей ⏳

2. **Расширенный интерфейс в MCP**:
   - Визуальное представление моделей для ролей ⏳
   - Интерактивное редактирование настроек в редакторе ⏳
   - Статистика использования моделей в редакторе ⏳

3. **Интеграция с системой задач**:
   - Автоматический выбор моделей на основе типа задачи ⏳
   - Адаптивное распределение задач между моделями ⏳
   - Отслеживание эффективности моделей для разных типов задач ⏳

### Команды MCP для управления моделями

Для интеграции с редакторами кода реализованы следующие MCP-команды:

1. `models_setup`: Интерактивный выбор моделей ✅
   ```json
   {
     "command": "models_setup",
     "params": {
       "roles": ["main", "research", "fallback", "analyzer", "summarizer"]
     }
   }
   ```

2. `models_list`: Просмотр настроенных моделей ✅
   ```json
   {
     "command": "models_list",
     "params": {}
   }
   ```

3. `models_set`: Установка конкретной модели для роли ✅
   ```json
   {
     "command": "models_set",
     "params": {
       "role": "analyzer",
       "provider": "anthropic",
       "model": "claude-3-opus",
       "parameters": {
         "temperature": 0.3
       }
     }
   }
   ```

4. `models_reset`: Сброс настроек моделей к значениям по умолчанию ⏳
   ```json
   {
     "command": "models_reset",
     "params": {
       "roles": ["all"] // или конкретные роли ["main", "analyzer"]
     }
   }
   ``` 

   Наша собственная реализация управления задачами включает:

1. **Структуры данных задач**:
   - Определение задач с полями для статуса, зависимостей, моделей и т.д.
   - Хранение задач в JSON-формате
   - Поддержка метаданных и расширенных атрибутов

2. **Система статусов задач**:
   - Поддержка статусов: pending, in-progress, done, deferred, blocked, review
   - Автоматическое обновление статусов при изменении зависимостей
   - Визуализация статусов с использованием эмодзи

3. **Управление зависимостями**:
   - Определение зависимостей между задачами
   - Проверка целостности графа зависимостей
   - Обработка циклических зависимостей

4. **Интерфейсы управления**:
   - CLI-команды для создания, просмотра и обновления задач
   - Интерактивный режим для управления задачами
   - MCP-команды для интеграции с редакторами кода

## Интеграция с системой цепочек моделей

Система задач Ricochet Task тесно интегрирована с оркестратором цепочек моделей:

1. **Задачи как модели в цепочке**:
   - Каждая модель в цепочке представлена как задача
   - Статус задачи отражает прогресс выполнения модели
   - Зависимости задач определяют порядок выполнения моделей

2. **Мониторинг выполнения**:
   - Отслеживание прогресса задач в реальном времени
   - Визуализация статусов и времени выполнения
   - Интерактивные прогресс-бары для длительных операций

## Система интерактивного выбора моделей

Наша собственная реализация интерактивного выбора моделей включает:
