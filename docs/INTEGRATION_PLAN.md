# План интеграции концепций claude-task-master в проект "Рикошет"

Этот документ описывает, как концепции и подходы из проекта [claude-task-master](https://github.com/eyaltoledano/claude-task-master) могут быть интегрированы в проект "Рикошет" для улучшения его функциональности и пользовательского опыта.

## 1. Обзор claude-task-master

Claude Task Master — это система управления задачами, разработанная для AI-ассистентов, которая:

1. **Разбивает проектные требования** на структурированные, выполнимые задачи
2. **Отслеживает зависимости** между задачами
3. **Определяет последовательность** выполнения задач
4. **Поддерживает контекст** между сессиями работы с AI-ассистентами
5. **Интегрируется с различными средами разработки** через MCP (Model Control Protocol)

Ключевая ценность claude-task-master — создание общего контекста между человеком и AI-ассистентом, что позволяет эффективно работать над сложными проектами.

## 2. Сопоставление концепций

| Концепция в claude-task-master | Аналог в "Рикошет" | Потенциал интеграции |
|-------------------------------|-------------------|---------------------|
| Парсинг PRD-документов в задачи | Сегментация входящих данных | Можно адаптировать парсер PRD для сегментации больших документов |
| Цепочки задач с зависимостями | Линейные цепочки моделей | Расширить концепцию цепочек до графов с зависимостями |
| Система статусов задач | Чекпоинты | Добавить метаданные к чекпоинтам для отслеживания статуса |
| Интеграция через MCP | API Gateway | Реализовать поддержку MCP для интеграции с редакторами |
| Файл tasks.json | Хранилище метаданных в PostgreSQL | Структура данных задач может быть адаптирована для БД |
| Поддержка разных AI-моделей | Подключение разных LLM | Использовать аналогичный подход к менеджменту API-ключей |
| Интерактивный выбор моделей | Настройка моделей для ролей | Адаптировать интерактивный интерфейс выбора моделей |

## 3. Ключевые компоненты для интеграции

### 3.1. Формат задачи

В claude-task-master каждая задача имеет следующую структуру:

```json
{
  "id": "task-1",
  "title": "Реализовать функцию сегментации текста",
  "description": "Создать функцию, которая разбивает большой текст на сегменты по ~2000 токенов с умным разделением на абзацы",
  "status": "todo",
  "dependencies": ["task-0"],
  "complexity": "medium",
  "files": ["src/segmentation.go"],
  "notes": "Использовать регулярные выражения для определения границ абзацев"
}
```

Для "Рикошет" рекомендуется:
1. Адаптировать этот формат для хранения в PostgreSQL
2. Добавить поля для метаданных о цепочке моделей
3. Расширить поле `dependencies` для поддержки направленного графа задач

### 3.2. MCP-интеграция

Claude Task Master использует MCP (Model Control Protocol) для интеграции с редакторами. Для "Рикошет" стоит:

1. Реализовать MCP-сервер для интеграции с редакторами (Cursor, VS Code)
2. Создать набор команд для взаимодействия с "Рикошет" через чат в редакторе
3. Использовать существующую документацию claude-task-master по настройке MCP

Пример конфигурации MCP для "Рикошет":

```json
{
  "mcpServers": {
    "ricochet": {
      "command": "npx",
      "args": ["-y", "--package=ricochet", "ricochet"],
      "env": {
        "ANTHROPIC_API_KEY": "YOUR_ANTHROPIC_API_KEY_HERE",
        "OPENAI_API_KEY": "YOUR_OPENAI_KEY_HERE",
        "GOOGLE_API_KEY": "YOUR_GOOGLE_KEY_HERE"
      }
    }
  }
}
```

#### 3.2.1. Команды MCP для интеграции с редакторами

Следующие MCP-команды будут реализованы для взаимодействия с Ricochet в редакторе:

1. **Базовые команды**:
   - `ricochet_init`: Инициализация проекта Ricochet
   - `ricochet_config`: Просмотр и изменение конфигурации
   - `ricochet_status`: Проверка статуса компонентов Ricochet

2. **Команды для управления цепочками**:
   - `chain_create`: Создание новой цепочки моделей
   - `chain_list`: Просмотр списка доступных цепочек
   - `chain_run`: Запуск цепочки моделей
   - `chain_edit`: Редактирование существующей цепочки
   - `chain_delete`: Удаление цепочки

3. **Команды для управления моделями**:
   - `models_setup`: Интерактивный выбор моделей
   - `models_list`: Просмотр настроенных моделей
   - `models_set`: Установка конкретной модели для роли
   - `models_reset`: Сброс настроек моделей

4. **Команды для управления задачами**:
   - `tasks_list`: Отображение списка активных задач
   - `task_details`: Просмотр деталей задачи
   - `task_status`: Отслеживание статуса выполнения задачи
   - `task_create`: Создание новой задачи
   - `task_delete`: Удаление задачи

5. **Команды для мониторинга**:
   - `monitor_chain`: Мониторинг выполнения конкретной цепочки
   - `monitor_task`: Мониторинг выполнения конкретной задачи
   - `monitor_usage`: Мониторинг использования API-ключей

6. **Команды для управления чекпоинтами**:
   - `checkpoint_list`: Просмотр списка доступных чекпоинтов
   - `checkpoint_get`: Получение содержимого чекпоинта
   - `checkpoint_create`: Создание нового чекпоинта
   - `checkpoint_delete`: Удаление чекпоинта

#### 3.2.2. Визуализация в редакторе

Для улучшения пользовательского опыта в редакторах кода будут реализованы следующие визуальные компоненты:

1. **Диаграмма цепочки**:
   - Визуальное представление структуры цепочки моделей
   - Отображение связей между моделями
   - Цветовая индикация статуса каждой модели в цепочке

   Пример:
   ```
   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
   │  Анализатор │ -> │ Суммаризатор│ -> │  Интегратор │
   │   (GPT-4)   │    │  (Claude-3) │    │ (DeepSeek)  │
   └─────────────┘    └─────────────┘    └─────────────┘
   ```

2. **Интерактивный монитор прогресса**:
   - Прогресс-бары для каждой модели в цепочке
   - Отображение текущей задачи и её прогресса
   - Время выполнения и оставшееся время
   - Использование токенов и примерная стоимость

3. **Панель результатов**:
   - Отображение промежуточных результатов
   - Возможность сравнения результатов разных моделей
   - Визуализация итоговых результатов

### 3.3. Командный интерфейс

Адаптировать следующие команды claude-task-master для "Рикошет":

1. **Инициализация проекта:**
   ```
   ricochet init
   ```

2. **Парсинг большого документа:**
   ```
   ricochet parse --file document.txt --chain "analyze-summarize-integrate"
   ```

3. **Проверка статуса задачи:**
   ```
   ricochet status --task-id 123
   ```

4. **Получение результата:**
   ```
   ricochet result --task-id 123
   ```

5. **Управление ключами:**
   ```
   ricochet key add --provider openai --key "sk-..."
   ricochet key list
   ```

### 3.4. Интеграция системы выбора моделей

Task Master имеет мощный механизм интерактивного выбора моделей, который будет адаптирован для "Рикошет". Основные компоненты для интеграции:

#### 3.4.1. Структура конфигурации моделей

В Task Master конфигурация моделей хранится в файле `.taskmaster/config.json`:

```json
{
  "models": {
    "main": {
      "provider": "openrouter",
      "model": "deepseek/deepseek-chat-v3-0324",
      "temperature": 0.7
    },
    "research": {
      "provider": "perplexity",
      "model": "sonar",
      "temperature": 0.7
    },
    "fallback": {
      "provider": "openrouter",
      "model": "mistralai/mistral-small-3.1-24b-instruct",
      "temperature": 0.7
    }
  }
}
```

Для "Рикошет" структура будет расширена для поддержки специализированных ролей в цепочках:

```json
{
  "models": {
    "main": {
      "provider": "openrouter",
      "model": "deepseek/deepseek-chat-v3-0324",
      "temperature": 0.7
    },
    "research": {
      "provider": "perplexity",
      "model": "sonar",
      "temperature": 0.7
    },
    "fallback": {
      "provider": "openrouter",
      "model": "mistralai/mistral-small-3.1-24b-instruct",
      "temperature": 0.7
    },
    "roles": {
      "analyzer": {
        "provider": "anthropic",
        "model": "claude-3-opus",
        "temperature": 0.3
      },
      "summarizer": {
        "provider": "openai",
        "model": "gpt-4",
        "temperature": 0.5
      },
      "integrator": {
        "provider": "deepseek",
        "model": "deepseek-coder",
        "temperature": 0.7
      }
    }
  }
}
```

#### 3.4.2. Интерактивный интерфейс выбора

Task Master использует библиотеку `inquirer` для создания интерактивного CLI-интерфейса. Для "Рикошет" будет реализован аналогичный интерфейс с использованием библиотеки `survey` для Go:

```go
package models

import (
    "github.com/AlecAivazis/survey/v2"
)

func SetupModels() error {
    // Получение списка доступных моделей
    providers, err := GetAvailableProviders()
    if err != nil {
        return err
    }
    
    // Создание опросов для каждой роли
    mainModelPrompt := &survey.Select{
        Message: "Выберите основную модель для генерации:",
        Options: providers.FormatOptions(),
    }
    
    // Аналогично для других ролей
    
    // Сохранение результатов в конфигурацию
    // ...
    
    return nil
}
```

#### 3.4.3. MCP-команды для интеграции с редакторами

Аналогично Task Master, "Рикошет" будет предоставлять MCP-команды для управления моделями из редакторов кода:

```typescript
// В MCP-хендлере
async function handleModelsSetup(request, response) {
    // Получение доступных моделей
    const providers = await getAvailableProviders();
    
    // Отправка интерактивного меню в редактор
    const mainModel = await response.promptSelect({
        prompt: "Выберите основную модель для генерации:",
        options: providers.formatOptions()
    });
    
    // Аналогично для других ролей
    
    // Сохранение результатов
    await saveModelConfig({
        main: mainModel,
        // ...
    });
    
    return { success: true, message: "Настройка моделей завершена" };
}
```

#### 3.4.4. Автоматический выбор моделей для ролей

В "Рикошет" при создании новой цепочки моделей система будет автоматически предлагать модели, соответствующие ролям:

```go
func SuggestModelForRole(role chain.ModelRole) (ModelConfig, error) {
    config, err := LoadModelConfig()
    if err != nil {
        return ModelConfig{}, err
    }
    
    // Попытка найти модель для указанной роли
    if roleConfig, ok := config.Roles[string(role)]; ok {
        return roleConfig, nil
    }
    
    // Если для роли нет специальной модели, использовать основную
    return config.Main, nil
}
```

### 3.5. Система задач и их мониторинг

Адаптация системы задач из Task Master для "Рикошет" включает:

#### 3.5.1. Структура задачи в Ricochet

Каждая задача в Ricochet представлена в следующем формате:

```json
{
  "id": "task-123",
  "type": "model_execution",
  "title": "Анализ структуры документа",
  "description": "Анализ структуры входного документа с выделением ключевых тем",
  "status": "completed",
  "dependencies": ["task-122"],
  "model": {
    "provider": "openai",
    "name": "gpt-4",
    "role": "analyzer",
    "parameters": {
      "temperature": 0.3,
      "max_tokens": 2000
    }
  },
  "input": {
    "type": "text",
    "source": "checkpoint-122",
    "segment": 1
  },
  "output": {
    "type": "text",
    "destination": "checkpoint-123"
  },
  "metrics": {
    "tokens_input": 1456,
    "tokens_output": 834,
    "duration_ms": 2300,
    "cost": 0.032
  },
  "created_at": "2023-06-01T10:15:30Z",
  "started_at": "2023-06-01T10:15:31Z",
  "completed_at": "2023-06-01T10:15:33Z"
}
```

#### 3.5.2. Система мониторинга задач

Система мониторинга в Ricochet предоставляет:

1. **Отслеживание статуса задач**:
   - Визуализация статуса каждой задачи в цепочке
   - Обновление в реальном времени через WebSocket
   - Уведомления о завершении или ошибках

2. **Детальная аналитика**:
   - Время выполнения каждой задачи
   - Использование токенов и стоимость
   - Производительность разных моделей для аналогичных задач

3. **Управление задачами**:
   - Приостановка и возобновление задач
   - Перенаправление задач на другие модели
   - Ручное создание чекпоинтов

4. **Интеграция с редактором**:
   - Отображение статуса задач непосредственно в редакторе
   - Привязка задач к конкретным файлам и участкам кода
   - Генерация отчетов о выполнении

#### 3.5.3. Визуализация прогресса задач

Для визуализации прогресса выполнения задач в CLI и редакторах будут использоваться интерактивные элементы:

```
Задача #123: Анализ структуры документа
┌───────────────────────────────────────────────────┐
│ Статус: ✅ Завершена                              │
│ Модель: OpenAI GPT-4 (Анализатор)                 │
│ Прогресс: [▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓] 100%       │
│ Время: 2.3с / 2.3с                                │
│ Токены: 1456 вход / 834 выход                     │
│ Стоимость: $0.032                                 │
└───────────────────────────────────────────────────┘

Зависимости:
 └── Задача #122: Сегментация документа ✅
```

## 4. План внедрения

### Этап 1: Прототип интеграции
- [ ] Изучить исходный код claude-task-master для понимания архитектуры
- [ ] Создать прототип хранения задач в формате, аналогичном claude-task-master
- [ ] Реализовать базовые команды CLI, вдохновленные claude-task-master
- [ ] **Создать прототип интерактивного выбора моделей на основе Task Master**

### Этап 2: Расширение возможностей
- [ ] Добавить поддержку MCP для интеграции с редакторами
- [ ] Реализовать визуализацию графа задач
- [ ] Создать расширенную документацию по использованию
- [ ] **Расширить механизм выбора моделей для поддержки специализированных ролей**

### Этап 3: Полная интеграция
- [ ] Разработать веб-интерфейс для управления задачами
- [ ] Реализовать интеграцию с системами контроля версий
- [ ] Добавить систему пользователей и разделение прав доступа
- [ ] **Реализовать двустороннюю синхронизацию настроек моделей с Task Master**

## 5. Примеры пользовательского взаимодействия

### Пример 1: Инициализация через MCP в редакторе

**Пользователь (в чате редактора)**: "Инициализируй Рикошет в моем проекте"

**Ассистент**:
```
Инициализирую Рикошет в вашем проекте...

✅ Создана структура директорий
✅ Настроены шаблоны цепочек
✅ Создан файл конфигурации .ricochet/config.yaml

Проект готов к использованию! Теперь вы можете:
1. Добавить API-ключи: `ricochet key add --provider openai`
2. Загрузить документ для обработки: `ricochet task run --file document.txt`
```

### Пример 2: Обработка документа

**Пользователь (в чате редактора)**: "Обработай файл research.pdf с помощью цепочки 'анализ-резюме'"

**Ассистент**:
```
Создаю задачу для обработки файла research.pdf...

📋 Задача #123 создана
📊 Документ разбит на 5 сегментов
🔄 Цепочка "анализ-резюме" будет применена к каждому сегменту
⏳ Начинаю обработку...

Вы можете проверить статус командой `ricochet status --task-id 123`
```

### Пример 3: Настройка моделей для цепочки

**Пользователь (в чате редактора)**: "Настрой модели для работы с Рикошет"

**Ассистент**:
```
Запускаю интерактивную настройку моделей...

✅ Начинаю интерактивную настройку моделей

Выберите основную модель для генерации:
> ✓ anthropic / claude-3-sonnet
  openai / gpt-4-turbo
  deepseek / deepseek-coder
  mistral / mistral-large

Выберите модель для роли "Анализатор":
> ✓ anthropic / claude-3-opus
  openai / gpt-4-turbo
  openai / gpt-4o

Выберите модель для роли "Суммаризатор":
> ✓ openai / gpt-4o
  anthropic / claude-3-sonnet
  mistral / mistral-large

Выберите модель для роли "Интегратор":
> ✓ deepseek / deepseek-coder
  openai / gpt-4-turbo
  anthropic / claude-3-haiku

✅ Настройка моделей завершена!

Установленные модели:
- Основная: anthropic / claude-3-sonnet
- Анализатор: anthropic / claude-3-opus
- Суммаризатор: openai / gpt-4o
- Интегратор: deepseek / deepseek-coder

Теперь вы можете создавать цепочки с этими моделями.
```

## 6. Выводы

Интеграция концепций claude-task-master в проект "Рикошет" позволит значительно улучшить пользовательский опыт и функциональность системы:

1. **Улучшение пользовательского опыта** через интеграцию с редакторами кода
2. **Структурированное управление задачами** обработки больших документов
3. **Сохранение контекста** между сессиями работы
4. **Расширяемость через подключение различных LLM-провайдеров**

Учитывая популярность claude-task-master (12.4k звезд на GitHub), адаптация его лучших практик может значительно ускорить принятие проекта "Рикошет" сообществом разработчиков. 